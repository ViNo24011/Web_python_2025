{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o phi·∫øu xu·∫•t</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/themify-icons@0.1.2/css/themify-icons.css">
    <link rel="stylesheet" href="{% static 'css/product.css' %}">
    <link rel="stylesheet" href="{% static 'css/export.css' %}">
</head>
<body>
    <div class="main">
        <div class="navbar">
            <a href="{% url 'users:home_page' %}" class="navbar__header">
                <p class="navbar__header-logo">Warehouse</p>
                <div class="navbar__header-wrapper">
                    <p class="navbar__header-text">Qu·∫£n l√Ω kho h√†ng</p>
                </div>
            </a>
            <div class="navbar__content">
                <div class="navbar__content-item">
                    <a href="{% url 'users:home_page' %}" class="navbar__content-item-link">
                        <i class="fa-solid fa-chart-pie navbar__content-icon"></i>
                        <p class="navbar__content-text">Th·ªëng k√™</p>
                    </a>
                </div>
                <div class="navbar__content-item">
                    <a href="#" class="navbar__content-item-link">
                        <i class="fa-solid fa-user-group navbar__content-icon"></i>
                        <p class="navbar__content-text">Qu·∫£n l√Ω ng∆∞·ªùi d√πng</p>
                    </a>
                </div>
                <div class="navbar__content-item">
                    <a href="{% url 'partners:customer_page' %}" class="navbar__content-item-link">
                        <i class="fa-solid fa-users navbar__content-icon"></i>
                        <p class="navbar__content-text">Qu·∫£n l√Ω kh√°ch h√†ng</p>
                    </a>
                </div>
                <div class="navbar__content-item">
                    <a href="#" class="navbar__content-item-link navbar__content-item-parent">
                        <i class="fa-solid fa-boxes-stacked navbar__content-icon"></i>
                        <p class="navbar__content-text">Qu·∫£n l√Ω s·∫£n ph·∫©m</p>
                        <i class="fa-solid fa-angle-down navbar__content-sub-icon"></i>
                    </a>
                    <div class="navbar__content-sub">
                        <a href="#" class="navbar__content-item-link">
                            <i class="fa-solid fa-truck-field navbar__content-icon"></i>
                            <p class="navbar__content-text">Nh√† cung c·∫•p</p>
                        </a>
                        <a href="{% url 'inventory:product_page' %}" class="navbar__content-item-link">
                            <i class="fa-solid fa-box navbar__content-icon"></i>
                            <p class="navbar__content-text">S·∫£n ph·∫©m</p>
                        </a>
                    </div>
                </div>
                <div class="navbar__content-item">
                    <a href="#" class="navbar__content-item-link navbar__content-item-parent active">
                        <i class="fa-solid fa-warehouse navbar__content-icon"></i>
                        <p class="navbar__content-text">Qu·∫£n l√Ω kho</p>
                        <i class="fa-solid fa-angle-down navbar__content-sub-icon"></i>
                    </a>
                    <div class="navbar__content-sub" style="display: block;">
                        <a href="#" class="navbar__content-item-link">
                            <i class="fa-solid fa-file-import fa-user-groug navbar__content-icon"></i>
                            <p class="navbar__content-text">Nh·∫≠p h√†ng</p>
                        </a>
                        <a href="{% url 'transactions:export_receipt_page' %}" class="navbar__content-item-link navbar__content-item-choose">
                            <i class="fa-solid fa-file-export navbar__content-icon"></i>
                            <p class="navbar__content-text">Xu·∫•t h√†ng</p>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="content__wrapper">
                <div class="content__header">
                    <p class="content__header-text">üìù T·∫°o phi·∫øu xu·∫•t h√†ng m·ªõi</p>
                </div>

                <form method="POST" action="{% url 'transactions:add_export_receipt' %}" id="exportForm" class="form-container">
                    {% csrf_token %}

                    <h3 class="form-section-title">üìã Th√¥ng tin kh√°ch h√†ng</h3>
                    
                    <div class="modal_product-infor">
                        <div class="modal__product-wrapper">
                            <label for="customer_name" class="modal__product-text-wrapper"><p class="modal__product-text">T√™n kh√°ch h√†ng</p><span class="modal__product-compulsory">*</span></label>
                            <input type="text" name="customer_name" id="customer_name" required placeholder="Nh·∫≠p t√™n kh√°ch h√†ng" class="modal__product-input">
                        </div>
                        
                        <div class="modal__product-wrapper">
                            <label for="customer_phone" class="modal__product-text-wrapper"><p class="modal__product-text">S·ªë ƒëi·ªán tho·∫°i</p><span class="modal__product-compulsory">*</span></label>
                            <input type="tel" name="customer_phone" id="customer_phone" required placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" class="modal__product-input">
                        </div>

                        <div class="modal__product-wrapper">
                            <label for="customer_email" class="modal__product-text-wrapper"><p class="modal__product-text">Email</p></label>
                            <input type="email" name="customer_email" id="customer_email" placeholder="Nh·∫≠p email (kh√¥ng b·∫Øt bu·ªôc)" class="modal__product-input">
                        </div>
                        
                        <div class="modal__product-wrapper">
                            <label for="customer_address" class="modal__product-text-wrapper"><p class="modal__product-text">ƒê·ªãa ch·ªâ</p><span class="modal__product-compulsory">*</span></label>
                            <input type="text" name="customer_address" id="customer_address" required placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng" class="modal__product-input">
                        </div>
                    </div>

                    <div class="modal__product-wrapper" style="width: 100%;">
                        <label for="note" class="modal__product-text-wrapper"><p class="modal__product-text">Ghi ch√∫</p></label>
                        <textarea name="note" id="note" placeholder="Nh·∫≠p ghi ch√∫ cho phi·∫øu xu·∫•t..." class="modal__product-textarea"></textarea>
                    </div>

                    <div class="products-section">
                        <h3 class="form-section-title">üì¶ Danh s√°ch s·∫£n ph·∫©m</h3>
                        <p class="price-note">üí° Gi√° b√°n = Gi√° g·ªëc √ó 150%</p>
                        <div id="productList"></div>
                        <button type="button" class="btn btn-secondary" onclick="addProductRow()">
                            ‚ûï Th√™m s·∫£n ph·∫©m
                        </button>

                        <div class="total-section">
                            <span class="total-label">T·ªïng ti·ªÅn:</span>
                            <span class="total-value" id="totalAmount">0 ƒë</span>
                        </div>
                    </div>

                    <div class="form-actions">
                        <a href="{% url 'transactions:export_receipt_page' %}" class="btn btn-back">‚Üê Quay l·∫°i</a>
                        <button type="submit" class="btn btn-primary">üíæ T·∫°o phi·∫øu xu·∫•t</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let productIndex = 0;

        const productsData = [
            {% for product in products %}
            {
                id: {{ product.id }},
                code: 'SP{{ product.id|stringformat:"03d" }}',
                name: '{{ product.name|escapejs }}',
                price: {{ product.price }},
                sellingPrice: {{ product.price }} * 1.5,
                unit: '{{ product.unit }}',
                category: '{{ product.category_name }}',
                quantity: {{ product.quantity }}
            },
            {% endfor %}
        ];

        function addProductRow() {
            productIndex++;
            const productList = document.getElementById('productList');
            
            const row = document.createElement('div');
            row.className = 'product-row';
            row.id = 'product-row-' + productIndex;
            
            // ƒê√£ c·∫≠p nh·∫≠t ƒë·ªÉ d√πng class CSS thay v√¨ style inline
            row.innerHTML = `
                <div>
                    <label>STT</label>
                    <input type="text" value="${productIndex}" readonly class="modal__product-input form-input-readonly">
                </div>
                <div>
                    <label>S·∫£n ph·∫©m <span class="modal__product-compulsory">*</span></label>
                    <select name="product_id[]" required onchange="updateProductInfo(this, ${productIndex})" class="modal__product-select modal__product-input">
                        <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
                        ${productsData.map(p => 
                            `<option value="${p.id}">${p.code} - ${p.name}</option>`
                        ).join('')}
                    </select>
                    <div class="product-info" id="info-${productIndex}"></div>
                </div>
                <div>
                    <label>Gi√° g·ªëc</label>
                    <input type="text" id="original-price-${productIndex}" readonly class="modal__product-input form-input-readonly" style="font-size: 1.2rem;">
                </div>
                <div>
                    <label>Gi√° b√°n</label>
                    <input type="text" id="price-${productIndex}" readonly class="modal__product-input form-input-readonly" style="color: #ff020f; font-weight: bold;">
                </div>
                <div>
                    <label>SL <span class="modal__product-compulsory">*</span></label>
                    <input type="number" name="quantity[]" id="quantity-${productIndex}" min="1" required onchange="calculateTotal()" class="modal__product-input">
                </div>
                <div>
                    <label>Th√†nh ti·ªÅn</label>
                    <input type="text" id="subtotal-${productIndex}" readonly class="modal__product-input form-input-readonly">
                </div>
                <div>
                    <label>&nbsp;</label>
                    <button type="button" class="btn-danger" onclick="removeProductRow(${productIndex})">üóëÔ∏è</button>
                </div>
            `;
            
            productList.appendChild(row);
        }

        function updateProductInfo(selectElement, index) {
            const productId = selectElement.value;
            const product = productsData.find(p => p.id == productId);
            
            if (product) {
                if (product.quantity <= 0) {
                    alert(`S·∫£n ph·∫©m "${product.name}" ƒë√£ h·∫øt h√†ng!`);
                    selectElement.value = '';
                    return;
                }
                
                document.getElementById('original-price-' + index).value = formatNumber(product.price) + ' ƒë';
                document.getElementById('price-' + index).value = formatNumber(product.sellingPrice) + ' ƒë';
                document.getElementById('info-' + index).innerHTML = 
                     `T·ªìn kho: <strong style="color: ${product.quantity > 10 ? '#4CAF50' : '#f44336'}">${product.quantity}</strong> ${product.unit} | ${product.category}`;
                
                quantityInput = document.getElementById('quantity-' + index);
                quantityInput.max = product.quantity;
                
                calculateTotal();
            } else {
                document.getElementById('original-price-' + index).value = '';
                document.getElementById('price-' + index).value = '';
                document.getElementById('info-' + index).innerHTML = '';
            }
        }

        function removeProductRow(index) {
            const row = document.getElementById('product-row-' + index);
            if (row) {
                row.remove();
                calculateTotal();
            }
        }

        function calculateTotal() {
            let total = 0;
            
            for (let i = 1; i <= productIndex; i++) {
                const row = document.getElementById('product-row-' + i);
                if (!row) continue;
                
                const selectElement = row.querySelector('select[name="product_id[]"]');
                const quantityInput = document.getElementById('quantity-' + i);
                const subtotalInput = document.getElementById('subtotal-' + i);
                
                if (selectElement && quantityInput) {
                    const productId = selectElement.value;
                    const quantity = parseInt(quantityInput.value) || 0;
                    const product = productsData.find(p => p.id == productId);
                    
                    if (product && quantity > 0) {
                        if (quantity > product.quantity) {
                            alert(`S·ªë l∆∞·ª£ng v∆∞·ª£t qu√° t·ªìn kho! (T·ªìn kho: ${product.quantity})`);
                            quantityInput.value = product.quantity;
                            return;
                        }
                        
                        const subtotal = product.sellingPrice * quantity;
                        subtotalInput.value = formatNumber(subtotal) + ' ƒë';
                        total += subtotal;
                    } else {
                        subtotalInput.value = '';
                    }
                }
            }
            
            document.getElementById('totalAmount').textContent = formatNumber(total) + ' ƒë';
        }

        function formatNumber(num) {
            return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        document.getElementById('exportForm').addEventListener('submit', function(e) {
            const productRows = document.querySelectorAll('.product-row');
            if (productRows.length === 0) {
                e.preventDefault();
                alert('Vui l√≤ng th√™m √≠t nh·∫•t 1 s·∫£n ph·∫©m!');
                return false;
            }
            
            let hasError = false;
            productRows.forEach((row, idx) => {
                const select = row.querySelector('select[name="product_id[]"]');
                const quantityInput = row.querySelector('input[name="quantity[]"]');
                
                if (select && quantityInput && select.value) {
                    const product = productsData.find(p => p.id == select.value);
                    const quantity = parseInt(quantityInput.value) || 0;
                    
                    if (quantity > product.quantity) {
                        alert(`S·∫£n ph·∫©m "${product.name}": S·ªë l∆∞·ª£ng xu·∫•t (${quantity}) v∆∞·ª£t qu√° t·ªìn kho (${product.quantity})!`);
                        hasError = true;
                    }
                }
            });
            
            if (hasError) {
                e.preventDefault();
                return false;
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            addProductRow();
        });

        // Script cho menu x·ªï xu·ªëng (th√™m t·ª´ product.html)
        document.querySelectorAll(".navbar__content-item .navbar__content-item-parent").forEach((title) => {
            title.addEventListener("click", function(event) {
                event.preventDefault();
                const child = this.nextElementSibling;
                const isOpen = child.style.display === "block";
                
                document.querySelectorAll(".navbar__content-sub").forEach(sub => {
                    if (sub !== child) {
                        sub.style.display = "none";
                        sub.previousElementSibling.classList.remove("active");
                    }
                });

                child.style.display = isOpen ? "none" : "block";
                this.classList.toggle("active", !isOpen);
            });
        });
    </script>
</body>
</html>